# AUDIT: Research Ã¼ber diese file

# CI pipeline for mdview.nvim
# - Node/TypeScript: install, lint, test, build client
# - Lua: basic static check with luacheck and optional busted unit tests
# - Self-Hosted Runner
# - Node.js + TypeScript and Lua/Busted fully parallel, with test reports and caching
# - Node + Lua with Test Reporting in GitHub UI

name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  node:
    name: Node.js / TypeScript
    runs-on: [self-hosted, linux, fast]
    steps:
      - uses: actions/checkout@v4

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Lint (TypeScript / JS)
        run: npm run lint

      - name: Run Vitest unit tests and output JUnit XML
        run: npm test -- --reporter=junit --outputFile=tests/node/vitest.xml
        continue-on-error: false

      - name: Upload Node test results to GitHub UI
        uses: mikeal/junit-report-action@v2
        with:
          results: tests/node/vitest.xml

      - name: Build client
        run: npm run build

      - name: Upload Node build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: node-build
          path: dist/

  lua:
    name: Lua / Neovim
    runs-on: [self-hosted]
    needs: node
    steps:
      - uses: actions/checkout@v4

      - name: Add local luarocks bin to PATH
        run: echo "${HOME}/.luarocks/bin" >> $GITHUB_PATH

      - name: Run luacheck
        run: luacheck lua/mdview --no-color || true

      - name: Run Lua unit tests with busted and output JUnit XML
        run: |
          mkdir -p tests/lua/output
          if command -v busted >/dev/null 2>&1; then
            busted -v \
              --pattern="*.spec.lua" \
              --lpath="./?.lua" \
              --output-junit=tests/lua/output/busted.xml \
              tests/lua || true
          else
            echo "busted not installed; skipping Lua unit tests"

      - name: Upload Lua test results to GitHub UI
        uses: mikeal/junit-report-action@v2
        with:
          results: tests/lua/output/busted.xml
